{% extends 'base.html' %}

{% block title %}Adicionar Nova Sessão{% endblock %}

{% block content %}
    <h2>Adicionar Nova Sessão</h2>
    <form method="post" class="form-container" id="form-sessao">
        <!-- Campos gerais da sessão -->
        <div class="form-group">
            <label for="id_sessao">ID da Sessão: *</label>
            <input type="text" id="id_sessao" name="id_sessao" required value="{{ form_data.get('id_sessao', '') }}">
        </div>
        <div class="form-group">
            <label for="data_sessao">Data da Sessão: *</label>
            <input type="date" id="data_sessao" name="data_sessao" required value="{{ form_data.get('data_sessao', '') }}">
        </div>
        <div class="form-group">
            <label for="dirigente">Dirigente: *</label>
            <input type="text" id="dirigente" name="dirigente" required value="{{ form_data.get('dirigente', '') }}">
        </div>
        <div class="form-group">
            <label for="explanacao">Explanação:</label>
            <input type="text" id="explanacao" name="explanacao" value="{{ form_data.get('explanacao', '') }}">
        </div>
        <div class="form-group">
            <label for="leitura_documentos">Leitura dos Documentos:</label>
            <input type="text" id="leitura_documentos" name="leitura_documentos" value="{{ form_data.get('leitura_documentos', '') }}">
        </div>
        <div class="form-group">
            <label for="mestre_assistente">Mestre Assistente:</label>
            <input type="text" id="mestre_assistente" name="mestre_assistente" value="{{ form_data.get('mestre_assistente', '') }}">
        </div>
        <div class="form-group">
            <label for="responsavel_preenchimento">Responsável pelo Preenchimento: *</label>
            <input type="text" id="responsavel_preenchimento" name="responsavel_preenchimento" required value="{{ form_data.get('responsavel_preenchimento', '') }}">
        </div>
        <div class="form-group">
            <label for="qtd_pessoas">Quantidade de Pessoas: *</label>
            <input type="number" id="qtd_pessoas" name="qtd_pessoas" required min="1" value="{{ form_data.get('qtd_pessoas', '') }}">
        </div>

        <hr class="section-divider">

        <!-- Seção para adicionar lotes de chá -->
        <h3>Lotes de Vegetal para a Sessão</h3>
        <div class="add-lote-section">
            <div class="form-group">
                <label for="lote-select">Selecione o Lote:</label>
                <select id="lote-select">
                    <option value="">Selecione um lote...</option>
                    <!-- ACESSO AOS DADOS ATUALIZADO AQUI -->
                    {% for lote in lotes_cha %}
                        <option value="{{ lote.id_lote }}" data-disponivel="{{ lote.litros_atuais }}">{{ lote.id_lote }} (Disponível: {{ lote.litros_atuais }}L)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="lote-qtd">Litros a retirar do lote:</label>
                <input type="number" id="lote-qtd" step="0.1" placeholder="ex: 5.5">
            </div>
            <button type="button" id="btn-add-lote" class="btn btn-add">Adicionar Lote à Sessão</button>
        </div>

        <h4>Lotes Selecionados:</h4>
        <div class="table-container">
            <table id="lotes-selecionados-tabela">
                <thead>
                    <tr>
                        <th>ID do Lote</th>
                        <th>Litros Retirados</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Linhas serão adicionadas aqui via JavaScript -->
                </tbody>
            </table>
        </div>
        <p><strong>Total retirado dos lotes (Litros Iniciais da Sessão): <span id="total-retirado">0.00</span> L</strong></p>

        <hr class="section-divider">
        
        <div class="form-group">
            <label for="litros_finais">Litros que Retornaram (após a sessão): *</label>
            <input type="number" id="litros_finais" name="litros_finais" required step="0.1">
        </div>

        <input type="hidden" id="lotes_utilizados_hidden" name="lotes_utilizados_hidden">

        <div class="form-group">
            <button type="submit">Salvar Sessão</button>
        </div>
    </form>

<script>
// O código JavaScript permanece o mesmo, pois ele interage com o HTML e não diretamente com as variáveis do Jinja2.
document.addEventListener('DOMContentLoaded', function() {
    const btnAddLote = document.getElementById('btn-add-lote');
    const loteSelect = document.getElementById('lote-select');
    const loteQtdInput = document.getElementById('lote-qtd');
    const tabelaCorpo = document.querySelector('#lotes-selecionados-tabela tbody');
    const totalRetiradoSpan = document.getElementById('total-retirado');
    const hiddenInput = document.getElementById('lotes_utilizados_hidden');
    const formSessao = document.getElementById('form-sessao');

    let lotesSelecionados = [];

    function atualizarTabelaEHiddenInput() {
        tabelaCorpo.innerHTML = '';
        let total = 0;
        let hiddenValue = [];

        lotesSelecionados.forEach((lote, index) => {
            const row = tabelaCorpo.insertRow();
            row.innerHTML = `
                <td>${lote.id}</td>
                <td>${lote.qtd.toFixed(2)} L</td>
                <td><button type="button" class="btn btn-delete btn-remove-lote" data-index="${index}">Remover</button></td>
            `;
            total += lote.qtd;
            hiddenValue.push(`${lote.id}:${lote.qtd}`);
        });

        totalRetiradoSpan.textContent = total.toFixed(2);
        hiddenInput.value = hiddenValue.join('|');
    }

    btnAddLote.addEventListener('click', function() {
        const selectedOption = loteSelect.options[loteSelect.selectedIndex];
        const id = selectedOption.value;
        const qtd = parseFloat(loteQtdInput.value);
        const disponivel = parseFloat(selectedOption.getAttribute('data-disponivel'));

        if (!id || isNaN(qtd) || qtd <= 0) {
            alert('Por favor, selecione um lote e insira uma quantidade válida.');
            return;
        }
        if (qtd > disponivel) {
            alert(`Erro: A quantidade retirada (${qtd}L) é maior que a disponível no lote (${disponivel}L).`);
            return;
        }
        if (lotesSelecionados.some(l => l.id === id)) {
            alert('Este lote já foi adicionado. Remova-o primeiro se quiser alterar a quantidade.');
            return;
        }

        lotesSelecionados.push({ id, qtd });
        atualizarTabelaEHiddenInput();

        loteSelect.selectedIndex = 0;
        loteQtdInput.value = '';
    });

    tabelaCorpo.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('btn-remove-lote')) {
            const indexToRemove = parseInt(e.target.getAttribute('data-index'));
            lotesSelecionados.splice(indexToRemove, 1);
            atualizarTabelaEHiddenInput();
        }
    });

    formSessao.addEventListener('submit', function() {
        atualizarTabelaEHiddenInput();
    });
});
</script>
{% endblock %}
