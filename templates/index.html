<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Sessões</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom-color: #f59e0b; color: #f59e0b; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem;
            color: white; z-index: 1000; opacity: 0; transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Registo de Sessões</h1>
                <p class="text-slate-500 text-sm">Gestão integrada de sessões e estoque.</p>
            </div>
            <div class="text-right">
                 <span class="text-sm font-medium text-slate-600">Sessão de: <b>{{ current_user.username }}</b></span>
                 <a href="{{ url_for('logout') }}" class="ml-4 text-sm text-red-500 hover:underline">Sair</a>
            </div>
        </header>

        <!-- Menu -->
        <nav class="mb-8">
            <ul class="flex border-b border-slate-200 overflow-x-auto whitespace-nowrap scrollbar-hide">
                <li class="-mb-px mr-1"><a class="inline-block py-3 px-6 font-semibold border-b-2 cursor-pointer tab-active" data-view="historico">Histórico</a></li>
                <li class="mr-1"><a class="inline-block py-3 px-6 font-semibold border-b-2 border-transparent hover:text-amber-600 cursor-pointer" data-view="estoque">Estoque</a></li>
                <li class="mr-1"><a class="inline-block py-3 px-6 font-semibold border-b-2 border-transparent hover:text-amber-600 cursor-pointer" data-view="consultas">Relatórios</a></li>
            </ul>
        </nav>

        <main>
            <!-- VIEW: HISTÓRICO -->
            <div id="historicoView" class="view-content">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold">Listagem de Sessões</h2>
                    <button id="openAddSessaoBtn" class="bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600 transition shadow-md">+ Nova Sessão</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b bg-slate-50">
                        <input type="text" id="searchMain" placeholder="Filtrar por nome ou dirigente..." class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div class="table-responsive">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-6 py-4">Sessão</th>
                                    <th class="px-6 py-4">Data</th>
                                    <th class="px-6 py-4">Dirigente</th>
                                    <th class="px-6 py-4">Explanação</th>
                                    <th class="px-6 py-4">Leitura Doc.</th>
                                    <th class="px-6 py-4">Consumo (L)</th>
                                    <th class="px-6 py-4">Por Pessoa</th>
                                    <th class="px-6 py-4 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="sessoesTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: ESTOQUE -->
            <div id="estoqueView" class="view-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="md:col-span-2">
                        <h2 class="text-xl font-bold mb-4">Lotes em Estoque</h2>
                        <button id="openAddLoteBtn" class="bg-slate-800 text-white py-2 px-6 rounded-lg hover:bg-slate-900 transition shadow-md">+ Entrada de Vegetal</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-amber-200 shadow-sm flex flex-col items-center justify-center">
                        <p class="text-xs font-bold text-amber-600 uppercase tracking-widest">Total Disponível</p>
                        <p id="totalStockDisplay" class="text-4xl font-black text-slate-800 mt-1">0.00 L</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden table-responsive">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-xs font-bold">
                            <tr>
                                <th class="px-6 py-4">ID Lote</th>
                                <th class="px-6 py-4">Data Prep.</th>
                                <th class="px-6 py-4">Responsável</th>
                                <th class="px-6 py-4">Qtd. Inicial</th>
                                <th class="px-6 py-4">Qtd. Atual</th>
                                <th class="px-6 py-4 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="estoqueTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: CONSULTAS -->
            <div id="consultasView" class="view-content hidden space-y-12">
                <!-- Relatório de Frequência -->
                <section>
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-2 h-8 bg-amber-500 rounded-full"></div>
                        <h2 class="text-xl font-bold">Quantitativo por Dirigente</h2>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <form id="relatorioForm" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Início</label>
                                <input type="date" name="data_inicio" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Fim</label>
                                <input type="date" name="data_fim" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                            <div class="flex gap-2">
                                <button type="button" id="clearRelatorioBtn" class="flex-1 bg-slate-100 py-2 rounded-lg hover:bg-slate-200 transition font-medium">Limpar</button>
                                <button type="submit" class="flex-[2] bg-amber-500 text-white font-bold py-2 rounded-lg hover:bg-amber-600 transition shadow-md">Gerar Relatório</button>
                            </div>
                        </form>
                    </div>
                    <div id="relatorioResultados" class="hidden mt-8 bg-white rounded-xl border shadow-sm overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-4 text-left text-slate-500 uppercase text-xs font-bold">Dirigente</th>
                                    <th class="px-6 py-4 text-right text-slate-500 uppercase text-xs font-bold">Nº de Sessões</th>
                                </tr>
                            </thead>
                            <tbody id="relatorioTableBody" class="divide-y"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Pesquisa Livre -->
                <section>
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-2 h-8 bg-slate-400 rounded-full"></div>
                        <h2 class="text-xl font-bold text-slate-600">Pesquisa Avançada</h2>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <form id="avancadaForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <input type="text" name="sessao" placeholder="Nome da Sessão" class="p-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-400">
                            <input type="text" name="dirigente" placeholder="Nome do Dirigente" class="p-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-400">
                            <input type="text" name="explanacao" placeholder="Tema Explanação" class="p-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-400">
                            <input type="text" name="leitura" placeholder="Tema Leitura" class="p-2 border rounded-lg outline-none focus:ring-2 focus:ring-slate-400">
                            <input type="date" name="data_ini" class="p-2 border rounded-lg text-slate-500 text-sm">
                            <input type="date" name="data_fim" class="p-2 border rounded-lg text-slate-500 text-sm">
                            
                            <div class="lg:col-span-3 flex justify-end gap-3 border-t pt-4">
                                <button type="button" id="clearAvancadaBtn" class="bg-slate-100 px-6 py-2 rounded-lg hover:bg-slate-200 transition">Limpar</button>
                                <button type="submit" class="bg-slate-700 text-white px-8 py-2 rounded-lg hover:bg-slate-800 font-bold transition">Pesquisar</button>
                            </div>
                        </form>
                    </div>
                    <div id="avancadaResultados" class="hidden mt-8 bg-white rounded-xl border shadow-sm overflow-hidden table-responsive">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold border-b">
                                <tr>
                                    <th class="px-6 py-4">Data</th>
                                    <th class="px-6 py-4">Sessão</th>
                                    <th class="px-6 py-4">Dirigente</th>
                                    <th class="px-6 py-4">Explanação</th>
                                    <th class="px-6 py-4">Leitura</th>
                                </tr>
                            </thead>
                            <tbody id="avancadaTableBody" class="divide-y"></tbody>
                        </table>
                    </div>
                    <div id="consultasSemResultados" class="hidden mt-6 p-12 text-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 text-slate-400">
                        Nenhum registo corresponde aos critérios de pesquisa.
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-2xl z-10 p-6 relative max-h-[90vh] overflow-y-auto">
            <button id="closeModal" class="absolute top-4 right-4 text-2xl text-slate-400">&times;</button>
            <h3 id="modalTitle" class="text-2xl font-bold mb-6"></h3>
            <div id="modalContent"></div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let sessoes = [], estoque = [], lotesSessao = [];
        const el = (id) => document.getElementById(id);
        const notify = (msg, type='success') => { const t = document.createElement('div'); t.className = `toast toast-${type} show`; t.innerText = msg; el('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000); };

        const load = async () => {
            try { const res = await fetch('/api/dados'); const d = await res.json(); sessoes = d.sessoes; estoque = d.estoque; render(); } catch(e) { notify('Erro servidor', 'error'); }
        };

        const render = () => {
            const term = el('searchMain').value.toLowerCase();
            // CORREÇÃO: Usar s.data_registro em vez de s.data_registo
            el('sessoesTableBody').innerHTML = sessoes.filter(s => (s.sessao+s.dirigente+s.explanacao+s.leitura_documentos).toLowerCase().includes(term)).map(s => `
                <tr class="hover:bg-slate-50"><td class="p-3 font-medium">${s.sessao}</td><td class="p-3">${s.data_sessao}</td><td class="p-3">${s.dirigente}</td><td class="p-3 text-slate-500">${s.explanacao||'-'}</td><td class="p-3 text-slate-500">${s.leitura_documentos||'-'}</td><td class="p-3 font-bold">${s.litros_consumidos.toFixed(2)}</td><td class="p-3">${s.consumo_por_pessoa_ml.toFixed(0)} ml</td><td class="p-3"><button onclick="del('sessoes', ${s.id})" class="text-red-500 hover:underline">Apagar</button></td></tr>
            `).join('') || '<tr><td colspan="8" class="p-4 text-center">Nada encontrado.</td></tr>';
            
            el('totalStockDisplay').innerText = estoque.reduce((a,b)=>a+b.litros_atuais,0).toFixed(2) + ' L';
            el('estoqueTableBody').innerHTML = estoque.map(l => `
                <tr class="hover:bg-slate-50"><td class="p-3 font-bold">${l.id_lote}</td><td class="p-3">${l.data_preparo}</td><td class="p-3">${l.responsavel}</td><td class="p-3">${l.litros_iniciais.toFixed(2)}</td><td class="p-3 font-black text-amber-600">${l.litros_atuais.toFixed(2)}</td><td class="p-3"><button onclick="del('estoque', ${l.id})" class="text-red-500 hover:underline">Apagar</button></td></tr>
            `).join('') || '<tr><td colspan="6" class="p-4 text-center">Estoque vazio.</td></tr>';
        };

        document.querySelectorAll('nav a').forEach(a => a.onclick = (e) => {
            document.querySelectorAll('nav a').forEach(x => x.classList.remove('tab-active', 'border-transparent')); e.target.classList.add('tab-active');
            document.querySelectorAll('.view-content').forEach(d => d.classList.add('hidden')); el(e.target.dataset.view + 'View').classList.remove('hidden');
        });

        el('closeModal').onclick = () => el('modal').classList.add('hidden');

        el('openAddLoteBtn').onclick = () => {
            el('modalTitle').innerText = "Novo Lote";
            el('modalContent').innerHTML = `<form id="fLote" class="space-y-4"><div class="grid grid-cols-2 gap-4"><input name="id_lote" placeholder="ID Lote" required class="p-2 border rounded w-full"><input type="date" name="data_preparo" required class="p-2 border rounded w-full"><input name="responsavel" placeholder="Resp." required class="p-2 border rounded w-full"><input type="number" step="0.01" name="litros_iniciais" placeholder="Litros" required class="p-2 border rounded w-full"></div><textarea name="observacoes" placeholder="Obs..." class="p-2 border rounded w-full"></textarea><button class="w-full bg-slate-800 text-white p-3 rounded font-bold">Salvar</button></form>`;
            el('modal').classList.remove('hidden'); el('modal').classList.add('flex');
            el('fLote').onsubmit = async (e) => { 
                e.preventDefault(); 
                const res = await fetch('/api/estoque', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(Object.fromEntries(new FormData(e.target)))}); 
                const msg = await res.json();
                if(res.ok){ notify('Lote salvo!'); el('modal').classList.add('hidden'); load(); } else { notify(msg.message || 'Erro', 'error'); } 
            };
        };

        el('openAddSessaoBtn').onclick = () => {
            lotesSessao = [];
            el('modalTitle').innerText = "Nova Sessão";
            const opts = estoque.filter(l=>l.litros_atuais>0).map(l=>`<option value="${l.id_lote}" data-max="${l.litros_atuais}">${l.id_lote} (${l.litros_atuais.toFixed(2)}L)</option>`);
            el('modalContent').innerHTML = `<form id="fSes" class="space-y-4"><div class="grid grid-cols-2 gap-4"><input name="sessao" id="nmSes" placeholder="Nome Sessão" required class="col-span-2 p-2 border rounded"><input type="date" name="data_sessao" id="dtSes" required class="p-2 border rounded"><input name="dirigente" placeholder="Dirigente" required class="p-2 border rounded"><input name="explanacao" placeholder="Explanação" class="p-2 border rounded"><input name="leitura_documentos" placeholder="Leitura Doc." class="p-2 border rounded"><input type="number" name="qtd_pessoas" placeholder="Qtd Pessoas" required class="p-2 border rounded"><input name="responsavel_preenchimento" placeholder="Responsável Registo" required class="p-2 border rounded"><input type="number" step="0.01" name="litros_finais" placeholder="Retorno de vegetal (Ex: 1.5)" required class="p-2 border rounded bg-amber-50"></div><div class="p-3 bg-slate-100 rounded"><div id="lstL" class="mb-2 space-y-1 text-sm"></div><div class="flex gap-2"><select id="sLote" class="flex-1 p-2 border rounded"><option value="">Lote...</option>${opts}</select><input type="number" id="sQtd" step="0.01" placeholder="L" class="w-20 p-2 border rounded"><button type="button" id="bAddL" class="bg-amber-500 text-white px-3 rounded">+</button></div></div><div class="flex items-center gap-2 text-sm"><input type="checkbox" id="chkR"><label>Gerar lote de retorno</label></div><input id="idR" name="id_lote_retorno" class="hidden w-full p-2 border rounded" placeholder="Nome Lote Retorno"><button class="w-full bg-amber-500 text-white p-3 rounded font-bold">Salvar</button></form>`;
            el('modal').classList.remove('hidden'); el('modal').classList.add('flex');
            
            el('chkR').onchange = (e) => {
                el('idR').classList.toggle('hidden', !e.target.checked);
                if(e.target.checked && el('nmSes').value && el('dtSes').value) {
                    const dt = new Date(el('dtSes').value).toLocaleDateString('pt-BR');
                    el('idR').value = `Retorno-${el('nmSes').value}-${dt}`;
                }
            };

            el('bAddL').onclick = () => {
                const sel = el('sLote'), qtd = parseFloat(el('sQtd').value);
                if(!sel.value || !qtd) return;
                const max = parseFloat(sel.options[sel.selectedIndex].dataset.max);
                if(qtd > max) return alert('Quantidade maior que o estoque!');
                lotesSessao.push({id:sel.value, qtd});
                el('lstL').innerHTML = lotesSessao.map((l,i)=>`<div class="flex justify-between bg-white p-1 px-2 rounded border"><span>${l.id}: <b>${l.qtd}L</b></span><span class="text-red-500 cursor-pointer" onclick="rmL(${i})">x</span></div>`).join('');
                el('sQtd').value = '';
            };
            window.rmL = (i) => { lotesSessao.splice(i,1); el('lstL').innerHTML = lotesSessao.map((l,x)=>`<div class="flex justify-between bg-white p-1 px-2 rounded border"><span>${l.id}: <b>${l.qtd}L</b></span><span class="text-red-500 cursor-pointer" onclick="rmL(${x})">x</span></div>`).join(''); };

            el('fSes').onsubmit = async (e) => {
                e.preventDefault(); if(!lotesSessao.length) return notify('Adicione vegetal!', 'error');
                const data = Object.fromEntries(new FormData(e.target));
                data.lotes_utilizados = lotesSessao.map(l=>`${l.id}:${l.qtd}`).join('|');
                data.litros_iniciais = lotesSessao.reduce((a,b)=>a+b.qtd,0);
                data.litros_consumidos = data.litros_iniciais - parseFloat(data.litros_finais);
                data.consumo_por_pessoa_ml = (data.litros_consumidos*1000)/parseInt(data.qtd_pessoas);
                data.registrar_retorno = el('chkR').checked;
                const res = await fetch('/api/sessoes', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
                const msg = await res.json();
                if(res.ok){ notify('Sucesso!'); el('modal').classList.add('hidden'); load(); } else { notify(msg.message || 'Erro', 'error'); }
            };
        };

        window.del = async (tipo, id) => { if(confirm('Certeza?')) { await fetch(`/api/${tipo}/${id}`, {method:'DELETE'}); notify('Apagado'); load(); } };
        el('searchMain').oninput = render;

        // Relatórios
        el('btnCleanRel').onclick = () => { el('relatorioForm').reset(); el('relatorioResultados').classList.add('hidden'); };
        el('relatorioForm').onsubmit = (e) => {
            e.preventDefault(); const fd = new FormData(e.target); const ini = new Date(fd.get('ini')), fim = new Date(fd.get('fim'));
            const counts = {}; sessoes.forEach(s => { const d = new Date(s.data_sessao.split('/').reverse().join('-')); if(d>=ini && d<=fim) counts[s.dirigente] = (counts[s.dirigente]||0)+1; });
            const sort = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
            el('relatorioTableBody').innerHTML = sort.map(r=>`<tr><td class="p-2 border-b">${r[0]}</td><td class="p-2 border-b text-right font-bold">${r[1]}</td></tr>`).join('');
            el('relatorioResultados').classList.remove('hidden');
        };

        // Pesquisa
        el('btnCleanPesq').onclick = () => { el('pesquisaForm').reset(); el('pesquisaResultados').classList.add('hidden'); el('consultasSemResultados').classList.add('hidden'); };
        el('pesquisaForm').onsubmit = (e) => {
            e.preventDefault(); const fd = new FormData(e.target);
            const term = (k) => (fd.get(k)||'').toLowerCase();
            const filt = sessoes.filter(s => 
                (!term('sessao') || s.sessao.toLowerCase().includes(term('sessao'))) &&
                (!term('dirigente') || s.dirigente.toLowerCase().includes(term('dirigente'))) &&
                (!term('explanacao') || (s.explanacao||'').toLowerCase().includes(term('explanacao'))) &&
                (!term('leitura') || (s.leitura_documentos||'').toLowerCase().includes(term('leitura')))
            );
            if(filt.length) {
                el('avancadaTableBody').innerHTML = filt.map(s => `<tr><td class="p-2 border-b">${s.data_sessao}</td><td class="p-2 border-b font-bold">${s.sessao}</td><td class="p-2 border-b">${s.dirigente}</td><td class="p-2 border-b text-sm">${s.explanacao||'-'}</td><td class="p-2 border-b text-sm">${s.leitura_documentos||'-'}</td></tr>`).join('');
                el('avancadaResultados').classList.remove('hidden'); el('consultasSemResultados').classList.add('hidden');
            } else {
                el('avancadaResultados').classList.add('hidden'); el('consultasSemResultados').classList.remove('hidden');
            }
        };

        load();
    });
    </script>
</body>
</html>